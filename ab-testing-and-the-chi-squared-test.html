<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-1812620-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-1812620-2');
  </script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
    styles: {
    ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
    },
    tex2jax: {
      inlineMath: [['$','$'], ['\\\\(','\\\\)']],
      displayMath: [['$$','$$'], ["\\[","\\]"]],
      processEscapes: true,
    }
    });
  </script>
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="/theme/css/style.min.css">
  <!--<link rel="stylesheet" type="text/css" href="/theme/css/pygments.min.css">-->
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments/github.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.min.css">
  <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bytepawn Atom">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="Marton Trencseni" />
<meta name="description" content="In an ealier post, I wrote about A/B testing conversion data with the Z-test. The Chi-squared test is a more general test for conversion data, because it can work with multiple conversion (and non-conversion) events, and multiple funnels being tested (A/B/C/D/..)." />
<meta name="keywords" content="ab-testing">
<meta property="og:site_name" content="Bytepawn"/>
<meta property="og:title" content="A/B testing and the Chi-squared test"/>
<meta property="og:description" content="In an ealier post, I wrote about A/B testing conversion data with the Z-test. The Chi-squared test is a more general test for conversion data, because it can work with multiple conversion (and non-conversion) events, and multiple funnels being tested (A/B/C/D/..)."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/ab-testing-and-the-chi-squared-test.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-02-28 00:00:00+01:00"/>
<meta property="article:modified_time" content="2020-02-28 00:00:00+01:00"/>
<meta property="article:author" content="/author/marton-trencseni.html">
<meta property="article:section" content="Data"/>
<meta property="article:tag" content="ab-testing"/>
<meta property="og:image" content="/images/chi2.png"/>

  <title>Bytepawn &ndash; A/B testing and the Chi-squared test</title>
</head>
<body>
  <aside>
    <div>
      <a href="/">
        <img src="/theme/img/profile.png" alt="" title="">
      </a>
      <h1><a href=""></a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="/">home</a></li>
          <li><a href="https://github.com/mtrencseni">github</a></li>
          <li><a href="https://www.linkedin.com/in/mtrencseni">linkedin</a></li>
          <li><a href="http://arxiv.org/find/all/1/au:+trencseni/0/1/0/all/0/1">arxiv</a></li>
        </ul>
      </nav>
      <ul class="social">
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h1 id="ab-testing-and-the-chi-squared-test">A/B testing and the Chi-squared test</h1>
    <p>Posted on Fri 28 February 2020 in <a href="/category/data.html">Data</a></p>
  </header>
  <div>
    <p>In an ealier post, I wrote about <a href="http://bytepawn.com/ab-testing-and-the-ztest.html">A/B testing conversion data with the Z-test</a>. The $\chi^2$ test is a more general test for conversion data, because it can work with multiple conversion (and non-conversion) events, and multiple funnels being tested (A/B/C/D/..).</p>
<p>Before we go on, let’s use a $\chi^2$ for a simple A/B conversion test and compare the results with the Z-test and the <a href="http://bytepawn.com/ab-testing-and-the-ttest.html">t-test</a> (two-taileds). First, a Monte Carlo algorithm to simulate A/B tests:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">choice</span><span class="p">(</span><span class="n">ps</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ps</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">ps</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">simulate_abtest</span><span class="p">(</span><span class="n">funnels</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="n">traffic_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">funnels</span><span class="p">]</span>
    <span class="n">observations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">funnels</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">funnels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])])</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">which_funnel</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">traffic_split</span><span class="p">)</span>
        <span class="n">funnel_outcome</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span><span class="n">funnels</span><span class="p">[</span><span class="n">which_funnel</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">observations</span><span class="p">[</span><span class="n">which_funnel</span><span class="p">][</span><span class="n">funnel_outcome</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">observations</span>
</pre></div>


<p>Next, let’s pretend we’re running a conversion A/B test that’s not working on $N=10,000$, and use the <a href="https://www.statsmodels.org/">statsmodel</a> and <a href="https://docs.scipy.org/doc/scipy/reference/stats.html">scipy stats</a> to run all three tests on the results:</p>
<div class="highlight"><pre><span></span><span class="n">funnels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">],</span> <span class="mf">0.6</span><span class="p">],</span> <span class="c1"># the first vector element is the actual outcomes, </span>
    <span class="p">[[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">],</span> <span class="mf">0.4</span><span class="p">],</span> <span class="c1"># the second is the traffic split</span>
<span class="p">]</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span>

<span class="n">observations</span> <span class="o">=</span> <span class="n">simulate_abtest</span><span class="p">(</span><span class="n">funnels</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Observations:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">observations</span><span class="p">)</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Chi-sq p = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">zt</span> <span class="o">=</span> <span class="n">ztest</span><span class="p">(</span><span class="o">*</span><span class="n">raw_data</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Z-test p = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="o">*</span><span class="n">raw_data</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;t-test p = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>All three yield the same p-value:</p>
<div class="highlight"><pre><span></span><span class="n">Observations</span><span class="p">:</span>
 <span class="p">[[</span><span class="mf">4825.</span> <span class="mf">1183.</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">3211.</span>  <span class="mf">781.</span><span class="p">]]</span>
<span class="n">Chi</span><span class="o">-</span><span class="n">sq</span> <span class="n">p</span> <span class="o">=</span> <span class="mf">0.876</span>
<span class="n">Z</span><span class="o">-</span><span class="n">test</span> <span class="n">p</span> <span class="o">=</span> <span class="mf">0.876</span>
<span class="n">t</span><span class="o">-</span><span class="n">test</span> <span class="n">p</span> <span class="o">=</span> <span class="mf">0.876</span>
</pre></div>


<p>We’re not surprised for the Z and the t-test, because as we saw in the previous post, above $N=100$, the t-distribution is a normal distribution, and the two yield the same p-value. For this simple case (two outcomes: conversion or no conversion, and two funnels: A and B), the $\chi^2$ is also identical to the Z-test, with the same limitation (below $N=100$ not reliable).</p>
<h2>The $\chi^2$ test</h2>
<p>For A/B testing, we can think of the $\chi^2$ test as a generalized Z-test. Generalized in the following sense:</p>
<ul>
<li>each of the funnels can have multiple outcomes, not just conversion and no-conversion; eg. imagine a funnel with multiple drop-offs (multiple mutually exclusive non-conversions) and multiple conversions such as buying a Monthly or an Annual license.</li>
<li>we can test more than 2 funnel versions at once, so we’re doing an A/B/C/D.. test.</li>
</ul>
<p>Let’s see this in action, eg. we have 3 outcomes and 4 funnels:</p>
<div class="highlight"><pre><span></span><span class="n">funnels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">],</span> <span class="mf">0.6</span><span class="p">],</span> <span class="c1"># the first vector is the actual outcomes,</span>
    <span class="p">[[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">],</span> <span class="mf">0.2</span><span class="p">],</span> <span class="c1"># the second is the traffic split</span>
    <span class="p">[[</span><span class="mf">0.79</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[[</span><span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">],</span>
<span class="p">]</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span>

<span class="n">observations</span> <span class="o">=</span> <span class="n">simulate_abtest</span><span class="p">(</span><span class="n">funnels</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Observations:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">observations</span><span class="p">)</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Chi-sq p = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>Prints something like:</p>
<div class="highlight"><pre><span></span><span class="n">Observations</span><span class="p">:</span>
 <span class="p">[[</span><span class="mf">4748.</span>  <span class="mf">595.</span>  <span class="mf">573.</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">1657.</span>  <span class="mf">197.</span>  <span class="mf">231.</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">807.</span>   <span class="mf">98.</span>  <span class="mf">103.</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">710.</span>  <span class="mf">195.</span>   <span class="mf">86.</span><span class="p">]]</span>
<span class="n">Chi</span><span class="o">-</span><span class="n">sq</span> <span class="n">p</span> <span class="o">=</span> <span class="mf">0.000</span>
</pre></div>


<p>What’s happening under the hood? Using the above 4x3 outcome table, first we construct the contingency table. We simply add the numbers row-wise and column-wise and write them at the end / bottom:</p>
<p><img src="/images/contingency_table.PNG" alt="Contingency table" style="width: 600px;"/></p>
<p>Then, for each obsevation cell, we calculate the expected value. Expected here means according to the null hypothesis, which is that all funnels are the same; our best guess for the null hypothesis are the blended bottom numbers: $7922/10000$ for no conversion, $195/10000$, etc. So for Funnel A, which has 5916 samples, our expected no conversion number would be $5916*7922/10000=4686.6$. We do this for each cell. Then we subtract the actual observation from the expected, square it, and divide by the expected, like $(4748-4686.6)^2/4686.6=0.8$. We do this for each cell, and sum up the numbers and we get the $\chi^2$ test statistic. We can then look this up in a $\chi^2$ distribution table. We have to use a degree of freedom of $k=(F-1)(C-1)$, where $F$ is the number of funnels, $C$ is the number of (no) conversion events, $F=4, C=3$ above.</p>
<h2>Implementation</h2>
<p>This is so simple, we can implement it ourselves:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">chi_squared</span><span class="p">(</span><span class="n">observations</span><span class="p">):</span>
    <span class="n">row_marginals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">col_marginals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row_marginals</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">col_marginals</span><span class="p">)):</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">row_marginals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">col_marginals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">N</span>
            <span class="n">chisq</span> <span class="o">+=</span> <span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">expected</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">expected</span>
    <span class="n">dof</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row_marginals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">col_marginals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">chi2</span><span class="p">(</span><span class="n">dof</span><span class="p">)</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">chisq</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">chisq</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span>
</pre></div>


<p>We can verify we calculate the same test statistic and p-value as the scipy library function:</p>
<div class="highlight"><pre><span></span><span class="n">funnels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">],</span> <span class="mf">0.6</span><span class="p">],</span> <span class="c1"># the first vector is the actual outcomes,</span>
    <span class="p">[[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">],</span> <span class="mf">0.2</span><span class="p">],</span> <span class="c1"># the second is the traffic split</span>
    <span class="p">[[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">],</span>
<span class="p">]</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span>

<span class="n">observations</span> <span class="o">=</span> <span class="n">simulate_abtest</span><span class="p">(</span><span class="n">funnels</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Observations:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">observations</span><span class="p">)</span>
<span class="n">ch_scipy</span> <span class="o">=</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Statsmodel chi-sq test statistic = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ch_scipy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Statsmodel chi-sq p = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ch_scipy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ch_our</span> <span class="o">=</span> <span class="n">chi_squared</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Our chi-sq test statistic = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ch_our</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Our chi-sq p = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ch_our</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>Prints something like:</p>
<div class="highlight"><pre><span></span><span class="n">Observations</span><span class="p">:</span>
 <span class="p">[[</span><span class="mf">4846.</span>  <span class="mf">594.</span>  <span class="mf">591.</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">1628.</span>  <span class="mf">188.</span>  <span class="mf">171.</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">767.</span>  <span class="mf">100.</span>   <span class="mf">98.</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">824.</span>   <span class="mf">84.</span>  <span class="mf">109.</span><span class="p">]]</span>
<span class="n">Statsmodel</span> <span class="n">chi</span><span class="o">-</span><span class="n">sq</span> <span class="n">test</span> <span class="n">statistic</span> <span class="o">=</span> <span class="mf">7.324</span>
<span class="n">Statsmodel</span> <span class="n">chi</span><span class="o">-</span><span class="n">sq</span> <span class="n">p</span> <span class="o">=</span> <span class="mf">0.292</span>
<span class="n">Our</span> <span class="n">chi</span><span class="o">-</span><span class="n">sq</span> <span class="n">test</span> <span class="n">statistic</span> <span class="o">=</span> <span class="mf">7.324</span>
<span class="n">Our</span> <span class="n">chi</span><span class="o">-</span><span class="n">sq</span> <span class="n">p</span> <span class="o">=</span> <span class="mf">0.292</span>
</pre></div>


<h2>Intuition</h2>
<p>The intuition behind the $\chi^2$ is this: if the null hypothesis is true, then all rows should follow the same conversion ratios, which is also the marginal conversion ratio vector. When we subtract the expected number from the actual number (and normalize), similar to the z-test, we get a standard normal variable. Since we have multiple cells, we need to add these variables to get an overall statistic, but we don’t want positive and negative fluctuations to cancel out. Hence we first square, and then add. So the $\chi^2$ is a sum of squares of standard normals. This is exactly what the $\chi^2$ distribution is: a $\chi^2$ distribution with degree of freedom $k$ is the result of adding up $k$ independent standard normal variables squared. In the subsequent discussion we will get more intuition why the degree of freedom is $k=(F-1)(C-1)$. Note that the standard normal goes from $-\infty$ to $\infty$, but the $\chi^2$, being its square, goes from $0$ to $\infty$. This has implications wrt one-sided vs two-sided testing, see later.</p>
<p><img src="/images/chi2.png" alt="Chi-squared distribution" style="width: 400px;"/></p>
<p>Finally, in the 2x2 case, why is this exactly the same as the z-test? The answer is simple: in the 2x2 case, the degree of freedom is 1, the $\chi^2$ test is doing exactly the same thing as a 2-sided Z-test, and in fact the $\chi^2$ test statistic in this case is $z^2$. We can see this numerically:</p>
<div class="highlight"><pre><span></span><span class="n">funnels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">],</span> <span class="mf">0.6</span><span class="p">],</span> <span class="c1"># the first vector is the actual outcomes,</span>
    <span class="p">[[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">],</span> <span class="mf">0.4</span><span class="p">],</span> <span class="c1"># the second is the traffic split</span>
<span class="p">]</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span>

<span class="n">observations</span> <span class="o">=</span> <span class="n">simulate_abtest</span><span class="p">(</span><span class="n">funnels</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Observations:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">observations</span><span class="p">)</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Chi-sq test statistic = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Chi-sq p = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">zt</span> <span class="o">=</span> <span class="n">ztest</span><span class="p">(</span><span class="o">*</span><span class="n">raw_data</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Z-test z = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Z-test z^2 = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Z-test p = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>Prints something like:</p>
<div class="highlight"><pre><span></span>Observations:
 [[4836. 1193.]
 [3147.  824.]]
Chi-sq test statistic = 1.378
Chi-sq p = 0.240
Z-test z = 1.174
Z-test z^2 = 1.378 # NOTICE: it’s the same as the Chi-sq test statistic
Z-test p = 0.240
</pre></div>


<p>If you compare the $\chi^2$ formulas with the z-test formulas from the previous post, it works out that $z^2 = \chi^2$.</p>
<h2>One tailed vs two tailed</h2>
<p>In the case of the z-test (and t-test), we have a choice between a one-tailed and a two-tailed test, to decide whether we want the test to go off for deviations in just one or both directions. In the case of the $\chi^2$ test, we do not have a choice:</p>
<ul>
<li>the $\chi^2$ distribution is asymmetric (from $0$ to $\infty$), so technically the $\chi^2$ test is always one-tailed</li>
<li>however, since it’s the squared of normals, both tails of the normal are folded together, so it corresponds to a two-tailed Z-test [in the 2x2 case]</li>
<li>this is not just a mathematical artefact; when dealing with multiple conversion events, there is no such thing as “positive” and “negative” directions; for example, in a 2x3 conversion example, if the baseline is $80-20-20$ for <strong>No Conversion - Monthly - Annual</strong>, and our test comes out at $79-21-20$ or $79-20-21$, which is “positive” and “negative”? If both are “positive”, then merge the conversions, and do a 2x2 one-tailed Z-test (or t-test).</li>
</ul>
<p>We can check this simply:</p>
<div class="highlight"><pre><span></span><span class="n">funnels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">],</span> <span class="mf">0.6</span><span class="p">],</span> <span class="c1"># the first vector is the actual outcomes,</span>
    <span class="p">[[</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">],</span> <span class="mf">0.4</span><span class="p">],</span> <span class="c1"># the second is the traffic split</span>
<span class="p">]</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span>

<span class="n">observations</span> <span class="o">=</span> <span class="n">simulate_abtest</span><span class="p">(</span><span class="n">funnels</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Observations:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">observations</span><span class="p">)</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Chi-sq p = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">zt</span> <span class="o">=</span> <span class="n">ztest</span><span class="p">(</span><span class="o">*</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Z-test p (TWO TAILED) = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="o">*</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;t-test p (TWO TAILED) = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">zt</span> <span class="o">=</span> <span class="n">ztest</span><span class="p">(</span><span class="o">*</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;larger&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Z-test p (ONE TAILED) = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="o">*</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;larger&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;t-test p (ONE TAILED) = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">zt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>Prints something like:</p>
<div class="highlight"><pre><span></span><span class="n">Observations</span><span class="p">:</span>
 <span class="p">[[</span><span class="mf">4780.</span> <span class="mf">1181.</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">3243.</span>  <span class="mf">796.</span><span class="p">]]</span>
<span class="n">Chi</span><span class="o">-</span><span class="n">sq</span> <span class="n">p</span>              <span class="o">=</span> <span class="mf">0.898</span> <span class="c1"># the first three are the same</span>
<span class="n">Z</span><span class="o">-</span><span class="n">test</span> <span class="n">p</span> <span class="p">(</span><span class="n">TWO</span> <span class="n">TAILED</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.898</span>
<span class="n">t</span><span class="o">-</span><span class="n">test</span> <span class="n">p</span> <span class="p">(</span><span class="n">TWO</span> <span class="n">TAILED</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.898</span>

<span class="n">Z</span><span class="o">-</span><span class="n">test</span> <span class="n">p</span> <span class="p">(</span><span class="n">ONE</span> <span class="n">TAILED</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.551</span> <span class="c1"># these are different</span>
<span class="n">t</span><span class="o">-</span><span class="n">test</span> <span class="n">p</span> <span class="p">(</span><span class="n">ONE</span> <span class="n">TAILED</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.551</span>
</pre></div>


<h2>Degrees of freedom</h2>
<p>When we're doing hypothesis testing, we're computing a p value. The p value is the probability that we'd get the measured outcome, or more extreme outcomes, assuming the null hypothesis is true. There is one caveat here, hidden in the "or more extreme": the statistically correct way to evaluate this "more extreme" part is by keeping the marginals (see above), both row and column marginals fixed. Ie. what are all the ways (their probabilities) that we can put different numbers in the contingency table, but while keeping the marginals fixed. Although the $\chi^2$ is not calculating this probability directly, thanks to the CLT, this is in fact what it's approximating in the $N \rightarrow \infty$ limit. And given a $F \times C$ table with the marginals fixed, you can only change $(F-1)(C-1)$ numbers freely ("degrees of freedom"), the rest are fixed by the marginals.</p>
<p>In the next post, I will talk about <a href="https://en.wikipedia.org/wiki/Fisher%27s_exact_test">Fisher's exact test</a>, which will give more intuition about this, because that test explicitly calculates this probability.</p>
<h2>Conclusion: usage and limitations</h2>
<p><strong>Z-test.</strong> In the 2x2 case, the $\chi^2$ yields exactly the same results as a two-tailed Z-test (or t-test).</p>
<p><strong>Central limit theorem.</strong> Like the Z-test, we need enough sample size for the normal approximation to be correct. I would not be comfortable unless each cell int he contingency table is at least $X&gt;100$.</p>
<p><strong>Multiple funnels, multiple outcomes.</strong> Unlike the Z-test, the $\chi^2$ test can test multiple funnels and multiple outcomes at the same time.</p>
<p><strong>One-tailed distribution.</strong> Unlike the Z-test, the $\chi^2$ test is directionless (technically one-tailed, but corresponds to the two-tailed Z-test in the 2x2 case).</p>
<p><strong>Degrees of freedom.</strong> For a test with F funnels and C outcomes, if you’re doing it manually, you have to use the $k=(F-1)(C-1)$ degree of freedom $\chi^2$ distribution to look up the p-value.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/ab-testing.html">ab-testing</a>
    </p>
  </div>
</article>

    <footer>
      <p>&copy; Marton Trencseni </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-1812620-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-1812620-2');
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "A/B testing and the Chi-squared test",
  "headline": "A/B testing and the Chi-squared test",
  "datePublished": "2020-02-28 00:00:00+01:00",
  "dateModified": "2020-02-28 00:00:00+01:00",
  "author": {
    "@type": "Person",
    "name": "Marton Trencseni",
    "url": "/author/marton-trencseni.html"
  },
  "image": "{{ SITEURL }}/{{ THEME_STATIC_DIR }}/img/profile.png",
  "url": "/ab-testing-and-the-chi-squared-test.html",
  "description": "In an ealier post, I wrote about A/B testing conversion data with the Z-test. The Chi-squared test is a more general test for conversion data, because it can work with multiple conversion (and non-conversion) events, and multiple funnels being tested (A/B/C/D/..)."
}
</script></body>
</html>