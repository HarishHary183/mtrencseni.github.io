<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-1812620-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-1812620-2');
  </script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
    styles: {
    ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
    },
    tex2jax: {
      inlineMath: [['$','$'], ['\\\\(','\\\\)']],
      displayMath: [['$$','$$'], ["\\[","\\]"]],
      processEscapes: true,
    }
    });
  </script>
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="/theme/css/style.min.css">
  <!--<link rel="stylesheet" type="text/css" href="/theme/css/pygments.min.css">-->
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments/github.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.min.css">
  <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Bytepawn Atom">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="Marton Trencseni" />
<meta name="description" content="I discuss the Z-test as it relates to A/B testing and clear up common misconceptions." />
<meta name="keywords" content="ab-testing">
<meta property="og:site_name" content="Bytepawn"/>
<meta property="og:title" content="A/B testing and the Z-test"/>
<meta property="og:description" content="I discuss the Z-test as it relates to A/B testing and clear up common misconceptions."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/ab-testing-and-the-ztest.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-02-15 00:00:00+01:00"/>
<meta property="article:modified_time" content="2020-02-15 00:00:00+01:00"/>
<meta property="article:author" content="/author/marton-trencseni.html">
<meta property="article:section" content="Data"/>
<meta property="article:tag" content="ab-testing"/>
<meta property="og:image" content="/images/100_statistical_tests.jpg"/>

  <title>Bytepawn &ndash; A/B testing and the Z-test</title>
</head>
<body>
  <aside>
    <div>
      <a href="/">
        <img src="/theme/img/profile.png" alt="" title="">
      </a>
      <h1><a href=""></a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="/">home</a></li>
          <li><a href="https://github.com/mtrencseni">github</a></li>
          <li><a href="https://www.linkedin.com/in/mtrencseni">linkedin</a></li>
          <li><a href="http://arxiv.org/find/all/1/au:+trencseni/0/1/0/all/0/1">arxiv</a></li>
        </ul>
      </nav>
      <ul class="social">
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h1 id="ab-testing-and-the-ztest">A/B testing and the Z-test</h1>
    <p>Posted on Sat 15 February 2020 in <a href="/category/data.html">Data</a></p>
  </header>
  <div>
    <h2>Introduction</h2>
<p>In the previous two posts, we talked about the <a href="http://bytepawn.com/ab-testing-and-the-central-limit-theorem.html">A/B testing and the Central Limit Theorem</a> and discussed when the CLT doesn’t hold in <a href="http://bytepawn.com/beyond-the-central-limit-theorem.html">Beyond the Central Limit Theorem</a> (CLT). The next step in exploring A/B testing is to look at the Z-test, which is the most common and straightforward hypotehesis testing tool.</p>
<p>With our understanding of the CLT, the Z-test is simple to explain. We’re running a Z-test if:</p>
<ul>
<li>our null hypothesis is the relationship between population means or other test statistics, and</li>
<li>we can assume that the CLT holds and the test statistics follow a normal distribution</li>
</ul>
<p>The same from <a href="https://en.wikipedia.org/wiki/Z-test">Wikipedia</a>:</p>
<blockquote>
<p>A Z-test is any statistical test for which the distribution of the test statistic under the null hypothesis can be approximated by a normal distribution.</p>
</blockquote>
<p><a href="https://github.com/mtrencseni/playground/blob/master/Conversion%20AB%20test%20with%20the%20Z-test.ipynb">The code shown below is up on Github.</a></p>
<h2>Statistical hypothesis testing</h2>
<p>In an A/B test setting, let’s assume it’s a conversion test, <a href="https://en.wikipedia.org/wiki/Statistical_hypothesis_testing">statistical hypothesis testing</a> is:</p>
<ul>
<li>we have two versions A and B, and we’re trying to decide whether B is better than A</li>
<li>if B is converting worse than A, then we’re done</li>
<li>if B is converting better than A, we’d like to know how <strong>significant</strong> our results are; in hypothesis testing, we compute the probability that we’d get this result if B is actually not better than A; ie. we compute the probability of seeing this B is better than A result due to random chance, even if B is not better than A; this probability is called the <strong>p-value</strong></li>
</ul>
<p>To get a better feeling for the point above, imagine if somebody gives you a coin. They claim it’s a fair coin, meaning you get Heads and Tails half the time. You want to test this claim, ie. the null hypothesis. If you flip it 10 times, and you get 6 Hs and 4 Ts, how confident are you that it’s not a fair coin? You can’t be too sure, because you haven’t collected enough data, because the 6:4 result is a very likely outcome even if the coin is fair. The 6:4 result is not significant enough to disprove the null hypothesis of a fair coin. But if you flip it 1000 times, and you get 599 Hs and 401 Ts, that’s very suspicios. The probability of getting 599:401 from a fair coin is very very unlikely (it can be calculated explicitly, see below).</p>
<h2>Types of Z-tests</h2>
<p>Some points to make our thinking about the Z-test clear.</p>
<p>The Z-test is not one specific test, it’s a family of tests, or a kind of test. Any time we make the above assumptions and work with a approximately normally distributed test statistic, we’re performing a Z-test. I will show different instances of Z-tests below.</p>
<p>It’s called Z-test because when running the numbers, it’s common to transform the data to a standard normal distribution N(0, 1). In the old days, before computers, the p-value, ie. the portion of the normal distribution outside of the normalized test statistic (eg. the difference of the means) would be read off a printout table (eg. the back of statistics textbooks), and this statistic is conventionally denoted with the letter z.</p>
<p>The practical bible of statistical testing, <a href="https://www.amazon.com/Statistical-Tests-Third-Gopal-Kanji/dp/141292376X">100 Statistical Tests</a> by Gopal Kanji, lists the following types of Z-tests:</p>
<ul>
<li>Test 1: Z-test for a population mean (variance known)</li>
<li>Test 2: Z-test for two population means (variances known and equal)</li>
<li>Test 3: Z-test for two population means (variances known and unequal)</li>
<li>Test 4: Z-test for a proportion (binomial distribution)</li>
<li>Test 5: Z-test for the equality of two proportions (binomial distribution)</li>
<li>Test 6: Z-test for comparing two counts (Poisson distribution)</li>
<li>Test 13: Z-test of a correlation coefficient</li>
<li>Test 14: Z-test for two correlation coefficients</li>
<li>Test 23: The Z-test for correlated proportions</li>
<li>Test 83: Z-test for the uncertainty of events</li>
<li>Test 84: Z-test for comparing sequential contingencies across two groups using the ‘log odds ratio’</li>
</ul>
<p><img src="/images/100_statistical_tests.jpg" alt="100 statistical tests" style="width: 300px;"/></p>
<p>I listed out these to further the point that the Z-test is not just one test, it’s a type of test that makes sense in a variety of scenarios.</p>
<h2>The maths</h2>
<p>The math is similar to the discussion in the CLT post. We’re sampling a distribution and computing a test statistic, and assuming that it follows a normal distribution $ N(\mu, \sigma^2) $. In an A/B test, we have two normal distributions, $ N(\mu_A, \sigma_A^2) $ and $ N(\mu_B, \sigma_B^2) $ with samples sizes, and the test statistic is $ N(\mu_A, \sigma_A^2) - N(\mu_B, \sigma_B^2) = N(\mu = \mu_A - \mu_B, \sigma^2 = \sigma_A^2 + \sigma_B^2) $ by the <a href="https://en.wikipedia.org/wiki/Sum_of_normally_distributed_random_variables">addition rule for normal distributions</a>.</p>
<p>The test statistic then is $ Z = \frac{ \mu }{ \sigma } $, we use this to get the p-value for the experiment. This is simply the normalized distance from the mean of the distribution. With this normalized distance, we can use a table for standard normal distribution $ N(0, 1) $ table and read off the p-value. In the age of computers, we actually don’t have to do this final normalization step to get Z, we can just get the p-value from the original $ N(\mu, \sigma^2) $ distribution.</p>
<p>In an A/B test setting, $ \mu_A $ and $ \mu_B $ are known. The trick is, what are the standard deviations $ \sigma_A^2 $ and $ \sigma_B^2 $? We compute it from the sample standard devation $ s^2 $, like $ \sigma^2 = s^2/N $.</p>
<p>The sample standard deviation is computed like:</p>
<ul>
<li>for conversion, the population distribution is Bernoulli, then $ s^2 = p(1-p) $ where $ p=\mu $, the conversion (for A and B)</li>
<li>for timespent, you can compute the standard error from the data directly $ s^2 = \frac{1}{N} \sum{(\mu - x_i)^2} $, where $x_i$ are the invididual timespents per user, and $ \mu = \frac{1}{N} \sum{ x_i } $.</li>
</ul>
<h2>Sample size</h2>
<p>Before running an A/B test, we have to decide 2 things:
- $ \alpha $, aka False Positive Rate (FPR): if B is actually not better than A, by chance the measurement can still show B to be better. We can reduce this by collecting more samples. But we need to set an FPR that we are okay with with. Usually people set this to 0.05, but as I discuss this in the previous post <a href="http://bytepawn.com/ab-tests-moving-fast-vs-being-sure.html">A/B tests: Moving Fast vs Being Sure</a>, startups should favor velocity over certainty, using 0.1 or 0.2 is fine.
- $ 1 - \beta $, the True Positive Rate (TPR): if B is actually better than A, how likely are we to actually measure B to be better at the above $ \alpha $? If we don't account for this, by default the math will work out set $ \beta = 0.5 $, which means we will only find half of the good Bs. For more on power, see <a href="https://influentialpoints.com/Training/statistical_power_and_sample_size-principles-properties-assumptions.htm">this aerticle</a>. We usually set power to 0.8.</p>
<h2>Simulating an A/B test</h2>
<p>Let’s pretend we’re running an A/B test on funnel conversion. A is the current, B is the new version of the funnel. We want to know whether B is better. By looking at our funnel dashboard, we know that A is historically converting around 9-11%.</p>
<p><strong>Step 1.</strong> Formulate the action hypothesis: B has higher conversion than A, meaning we're doing a one-sided test.</p>
<p><strong>Step 2.</strong> We set $ \alpha = 0.10 $ and $ \beta = 0.80 $. This means we're okay with 10% false positives and we will capture 80% of improvements.</p>
<p><strong>Step 3.</strong> Decide traffic split. Let’s say we will keep 80% in A, 20% in B. This is how much of a chance we take, B could be worse, buggy, etc.</p>
<p><strong>Step 4.</strong> Figure out how many samples we need to collect, given the historic conversion, traffic split, alpha and the kind of lift we’re looking. The code below computes sample size based on the math above:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>

<span class="k">def</span> <span class="nf">alpha_to_z</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">one_sided</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">one_sided</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="k">return</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">beta_to_z</span><span class="p">(</span><span class="n">beta</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">beta</span>
    <span class="k">return</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">num_samples</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">mu_A</span><span class="p">,</span> <span class="n">mu_delta</span><span class="p">,</span> <span class="n">traffic_ratio_A</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span> <span class="n">one_sided</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">z_alpha</span> <span class="o">=</span> <span class="n">alpha_to_z</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">one_sided</span><span class="p">)</span>
    <span class="n">z_beta</span>  <span class="o">=</span> <span class="n">beta_to_z</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
    <span class="n">mu_B</span> <span class="o">=</span> <span class="n">mu_A</span> <span class="o">+</span> <span class="n">mu_delta</span>
    <span class="n">traffic_ratio_B</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">traffic_ratio_A</span>
    <span class="n">N</span> <span class="o">=</span> <span class="p">(</span> <span class="n">mu_A</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">mu_A</span><span class="p">)</span><span class="o">/</span><span class="n">traffic_ratio_A</span> <span class="o">+</span> <span class="n">mu_B</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">mu_B</span><span class="p">)</span><span class="o">/</span><span class="n">traffic_ratio_B</span> <span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">z_alpha</span><span class="o">+</span><span class="n">z_beta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mu_A</span> <span class="o">-</span> <span class="n">mu_B</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>  
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</pre></div>


<p>Note that in real-life, there are other considerations. For example, if possible we should run tests for complete days and/or weeks, to capture users who are active at different times. So when we calculate the sample size, in real life we compare that to the number of users going through the funnel per day/week, and "round up". To take this into account in the simulation below, I will multiply by 2.</p>
<p><strong>Step 5.</strong> Create a random seed for the A/B test and save it server-side. We generate a new seed for each A/B test. Let’s say we generate the string for this one: <code>OkMdZa18pfr8m5sy2IL52pW9ol2EpLekgakJAIZFBbgZ</code></p>
<p><strong>Step 6.</strong> Perform test by splitting users randomly between A and B according to the above proportions. Users coming, identified by a <code>user_id</code> (or <code>cookie_id</code>), should be put in the same funnel. We can accomplish this by hashing the <code>test_id</code>, where <code>test_id = seed + user_id</code>:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hashlib</span>

<span class="n">test_seed</span> <span class="o">=</span> <span class="s1">&#39;OkMdZa18pfr8m5sy2IL52pW9ol2EpLekgakJAIZFBbgZ&#39;</span>

<span class="k">def</span> <span class="nf">funnel_user</span><span class="p">(</span><span class="n">base_traffic_split</span><span class="p">,</span> <span class="n">test_seed</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
    <span class="n">test_id</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">test_seed</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">bits</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">test_id</span><span class="p">,</span> <span class="mi">16</span><span class="p">))[</span><span class="mi">3</span><span class="p">:]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bits</span><span class="p">)])</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">base_traffic_split</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;B&#39;</span>
</pre></div>


<p><strong>Step 7.</strong> Run the test. We're simulating the real-world here, so we will have to pick the actual conversions for A and B. This is not known to the test, this is what it's trying to estimate, so we will call this a hidden variable:</p>
<div class="highlight"><pre><span></span><span class="n">hidden_conversion_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mf">0.105</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mf">0.115</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">run_test</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">hidden_conversion_params</span><span class="p">,</span> <span class="n">funnel_user_func</span><span class="p">):</span>
    <span class="n">test_outcomes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;conversions&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;conversions&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}</span>
    <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">which_funnel</span> <span class="o">=</span> <span class="n">funnel_user_func</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="c1"># returns &#39;A&#39; or &#39;B&#39;</span>
        <span class="n">test_outcomes</span><span class="p">[</span><span class="n">which_funnel</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">hidden_conversion_params</span><span class="p">[</span><span class="n">which_funnel</span><span class="p">]:</span>
            <span class="n">test_outcomes</span><span class="p">[</span><span class="n">which_funnel</span><span class="p">][</span><span class="s1">&#39;conversions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">test_outcomes</span>
</pre></div>


<p><strong>Step 8.</strong> Compute the p-value and compare it with the $ \alpha $ we set to decide whether to accept or reject B:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">p_value</span><span class="p">(</span><span class="n">N_A</span><span class="p">,</span> <span class="n">mu_A</span><span class="p">,</span> <span class="n">N_B</span><span class="p">,</span> <span class="n">mu_B</span><span class="p">,</span> <span class="n">one_sided</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">sigma_A_squared</span> <span class="o">=</span> <span class="n">mu_A</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mu_A</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_A</span>
    <span class="n">sigma_B_squared</span> <span class="o">=</span> <span class="n">mu_B</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mu_B</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_B</span>
    <span class="n">sigma_squared</span> <span class="o">=</span> <span class="n">sigma_A_squared</span> <span class="o">+</span> <span class="n">sigma_B_squared</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu_B</span> <span class="o">-</span> <span class="n">mu_A</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_squared</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">z_to_p</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">one_sided</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.50</span>
<span class="n">base_conversion</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="n">valuable_diff</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">base_traffic_split</span> <span class="o">=</span> <span class="mf">0.8</span>

<span class="n">N_required</span> <span class="o">=</span> <span class="n">num_samples</span><span class="p">(</span>
    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
    <span class="n">mu_A</span><span class="o">=</span><span class="n">base_conversion</span><span class="p">,</span>
    <span class="n">mu_delta</span><span class="o">=</span><span class="n">valuable_diff</span><span class="p">,</span>
    <span class="n">traffic_ratio_A</span><span class="o">=</span><span class="n">base_traffic_split</span><span class="p">,</span>
    <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">N_actual</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">N_required</span> <span class="c1"># because eg. we run it for a whole week</span>

<span class="c1"># hidden_conversion_params is how our funnels actually perform:</span>
<span class="c1"># the difference between the two is what we&#39;re trying to establish</span>
<span class="c1"># with statistical confidence, using an A/B test</span>
<span class="n">hidden_conversion_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mf">0.105</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mf">0.115</span> <span class="p">}</span>
<span class="n">test_seed</span> <span class="o">=</span> <span class="s1">&#39;OkMdZa18pfr8m5sy2IL52pW9ol2EpLekgakJAIZFBbgZ&#39;</span>
<span class="n">test_outcomes</span> <span class="o">=</span> <span class="n">run_test</span><span class="p">(</span>
    <span class="n">N_actual</span><span class="p">,</span>
    <span class="n">hidden_conversion_params</span><span class="p">,</span>
    <span class="k">lambda</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">funnel_user</span><span class="p">(</span><span class="n">base_traffic_split</span><span class="p">,</span> <span class="n">test_seed</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">test_outcomes</span><span class="p">)</span>

<span class="n">mu_A</span> <span class="o">=</span> <span class="n">test_outcomes</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">][</span><span class="s1">&#39;conversions&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_outcomes</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">]</span>
<span class="n">mu_B</span> <span class="o">=</span> <span class="n">test_outcomes</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">][</span><span class="s1">&#39;conversions&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_outcomes</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Measured conversion for A: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mu_A</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Measured conversion for B: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mu_B</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">p_value</span><span class="p">(</span><span class="n">test_outcomes</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="n">mu_A</span><span class="p">,</span> <span class="n">test_outcomes</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="n">mu_B</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;p-value: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>
<span class="k">if</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">alpha</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;B is better, deploy&quot;&quot;&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;We&#39;re not sure if B is better than A&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>


<p>If you run this repeatedly, sometimes it will indicate B is better, sometimes it will not. It will find B better more often:</p>
<ul>
<li>at higher $ N $ (lower $s$)</li>
<li>at higher $ \beta $</li>
<li>at lower $ \alpha $</li>
<li>if the conversion advantage of B is greater in the hidden conversion parameters</li>
</ul>
<h2>Consistency test for FPR ($\alpha$)</h2>
<p>We can set the A and B hidden conversion parameters, repeatedly perform the A/B test, and count the ratio of times it finds B to be better than A at the $ \alpha $ level, ie. the ratio of false positives. It should be equal to the $ \alpha $ we set to compute the sample size!</p>
<div class="highlight"><pre><span></span><span class="n">num_tests</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="n">base_conversion</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="n">valuable_diff</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">base_traffic_split</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">hidden_conversion_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mf">0.10</span> <span class="p">}</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">num_samples</span><span class="p">(</span>
    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
    <span class="n">mu_A</span><span class="o">=</span><span class="n">base_conversion</span><span class="p">,</span>
    <span class="n">mu_delta</span><span class="o">=</span><span class="n">valuable_diff</span><span class="p">,</span>
    <span class="n">traffic_ratio_A</span><span class="o">=</span><span class="n">base_traffic_split</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># get rid of this of the hashing, it&#39;s slow, we don&#39;t need it for a simulation</span>
<span class="k">def</span> <span class="nf">funnel_user</span><span class="p">(</span><span class="n">base_traffic_split</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">base_traffic_split</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;B&#39;</span>

<span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="n">num_tests</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">hidden_conversion_params</span><span class="p">,</span> <span class="n">funnel_user_func</span><span class="p">):</span>
    <span class="n">num_successes</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tests</span><span class="p">):</span>
        <span class="n">test_outcomes</span> <span class="o">=</span> <span class="n">run_test</span><span class="p">(</span>
            <span class="n">N</span><span class="p">,</span>
            <span class="n">hidden_conversion_params</span><span class="p">,</span>
            <span class="n">funnel_user_func</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mu_A</span> <span class="o">=</span> <span class="n">test_outcomes</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">][</span><span class="s1">&#39;conversions&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_outcomes</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">]</span>
        <span class="n">mu_B</span> <span class="o">=</span> <span class="n">test_outcomes</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">][</span><span class="s1">&#39;conversions&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_outcomes</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p_value</span><span class="p">(</span><span class="n">test_outcomes</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="n">mu_A</span><span class="p">,</span> <span class="n">test_outcomes</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="n">mu_B</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">alpha</span><span class="p">:</span>
            <span class="n">num_successes</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">num_successes</span>

<span class="n">num_successes</span> <span class="o">=</span> <span class="n">run_tests</span><span class="p">(</span>
    <span class="n">num_tests</span><span class="p">,</span>
    <span class="n">N</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">,</span>
    <span class="n">hidden_conversion_params</span><span class="p">,</span>
    <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">funnel_user</span><span class="p">(</span><span class="n">base_traffic_split</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">fpr</span> <span class="o">=</span> <span class="n">num_successes</span><span class="o">/</span><span class="n">num_tests</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;False Positive Rate = </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fpr</span><span class="p">)</span>
</pre></div>


<p>It prints:</p>
<div class="highlight"><pre><span></span>False Positive Rate = 0.10
</pre></div>


<h2>Consistency test for TPR ($\beta$)</h2>
<p>We can set the A and B hidden conversion parameters exactly like the assumption we used to compute the sample size (ie. 10% and 11%), repeatedly perform the A/B test, and count the ratio of times it finds B to be better than A at the $ \alpha $ level. It should be equal to the $ \beta $ power we set to compute the sample size!</p>
<div class="highlight"><pre><span></span><span class="n">num_tests</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.80</span>
<span class="n">base_conversion</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="n">valuable_diff</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">base_traffic_split</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">hidden_conversion_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mf">0.11</span> <span class="p">}</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">num_samples</span><span class="p">(</span>
    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
    <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
    <span class="n">mu_A</span><span class="o">=</span><span class="n">base_conversion</span><span class="p">,</span>
    <span class="n">mu_delta</span><span class="o">=</span><span class="n">valuable_diff</span><span class="p">,</span>
    <span class="n">traffic_ratio_A</span><span class="o">=</span><span class="n">base_traffic_split</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">num_successes</span> <span class="o">=</span> <span class="n">run_tests</span><span class="p">(</span>
    <span class="n">num_tests</span><span class="p">,</span>
    <span class="n">N</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">,</span>
    <span class="n">hidden_conversion_params</span><span class="p">,</span>
    <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">funnel_user</span><span class="p">(</span><span class="n">base_traffic_split</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">tpr</span> <span class="o">=</span> <span class="n">num_successes</span><span class="o">/</span><span class="n">num_tests</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;True Positive Rate: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tpr</span><span class="p">)</span>
</pre></div>


<p>It prints:</p>
<div class="highlight"><pre><span></span>True Positive Rate: 0.80
</pre></div>


<p>Related links:</p>
<ul>
<li><a href="https://towardsdatascience.com/the-art-of-a-b-testing-5a10c9bb70a4">The Art of A/B Testing</a> - good post on the same topic</li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/ab-testing.html">ab-testing</a>
    </p>
  </div>
</article>

    <footer>
      <p>&copy; Marton Trencseni </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-1812620-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-1812620-2');
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "A/B testing and the Z-test",
  "headline": "A/B testing and the Z-test",
  "datePublished": "2020-02-15 00:00:00+01:00",
  "dateModified": "2020-02-15 00:00:00+01:00",
  "author": {
    "@type": "Person",
    "name": "Marton Trencseni",
    "url": "/author/marton-trencseni.html"
  },
  "image": "{{ SITEURL }}/{{ THEME_STATIC_DIR }}/img/profile.png",
  "url": "/ab-testing-and-the-ztest.html",
  "description": "I discuss the Z-test as it relates to A/B testing and clear up common misconceptions."
}
</script></body>
</html>